# Ansible: Ansible playbooks - Install HTTPD

## ðŸ”¹ Step 01: Update Directory Structure

```bash
â”œâ”€â”€ install_httpd.yml
â”œâ”€â”€group_vars
â”‚   â””â”€â”€ all.yml
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html.j2   # Jinja2 template
â””â”€â”€ files/
    â””â”€â”€ (optional static files)
```

## ðŸ”¹ Step 02: Create a Jinja2 Template

Modify `templates/index.html.j2` to include dynamic content:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>{{ page_title }}</title>
  </head>
  <body>
    <h1>{{ welcome_message }}</h1>
    <p>Hostname: {{ ansible_hostname }}</p>
    <p>OS: {{ ansible_os_family }} {{ ansible_distribution_version }}</p>
    <p>Timestamp: {{ ansible_date_time.iso8601 }}</p>

    {% if additional_message is defined %}
    <div>{{ additional_message }}</div>
    {% endif %}
  </body>
</html>
```

## ðŸ”¹ Step 03: Update the Playbook

Modify `httpd.yaml` to use the template and define variables:

```yaml
---
- name: Install and configure Apache HTTP Server on RHEL 9
  hosts: all
  become: yes
  vars:
    page_title: "Apache Server"
    welcome_message: "Welcome to {{ inventory_hostname }}"
    additional_message: "This server is managed by Jinja2!" # Optional variable

  tasks:
    - name: Install httpd package
      yum:
        name: httpd
        state: present

    - name: Ensure httpd service is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Deploy dynamic index.html using Jinja2
      ansible.builtin.template: # Replace 'copy' with 'template'
        src: templates/index.html.j2
        dest: /var/www/html/index.html
        owner: apache
        group: apache
        mode: 0644
      notify:
        - Reload httpd

    - name: Open firewall ports for HTTP/HTTPS (optional)
      ansible.builtin.firewalld:
        service: "{{ item }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ firewall_services }}" # Use a variable for flexibility
      when:
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version == '9'
      notify:
        - Reload firewalld

  handlers:
    - name: Reload firewalld
      ansible.builtin.service:
        name: firewalld
        state: reloaded

    - name: Reload httpd
      ansible.builtin.service:
        name: httpd
        state: reloaded
```

## ðŸ”¹ Step 04 : Add Variables (Optional)

Define variables in `group_vars/all.yml` or directly in the playbook:

```yaml
# Example group_vars/all.yml
firewall_services:
  - http
  - https
additional_message: "This server is part of the {{ env }} environment" # Use with `-e env=prod`
```

# Concepts

## handlers

In Ansible, handlers are special tasks that run only when notified by other tasks. They are typically used to perform actions after a change is made, such as restarting a service or reloading a configuration. Handlers are idempotent, meaning they run once even if triggered multiple times.

### Key Features of Handlers:

- **Triggered by Notifications**: A task "notifies" a handler if it makes a change.
- **Run Once**: Even if notified multiple times, a handler runs only once at the end of the playbook.
- **Order of Execution**: Handlers run in the order they are defined in the handlers section (not the order of notification).

#### NOTE

**Handlers in Ansible execute only if the task that notifies them reports a change.**

### How It Works:

1. **Task Runs**: A task with a notify directive executes.

2. **Check for Change**:
   - If the task **_changes_** the system (e.g., modifies a file, installs a package), it triggers the handler.
   - If the task **_does not change_** the system (e.g., the file is already up-to-date), the handler is **_not_** triggered.
3. **Handler Execution**: All notified handlers run **_once_** at the end of the playbook.
