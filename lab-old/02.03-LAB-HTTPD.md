# Ansible: Ansible playbooks - Install HTTPD

## ðŸ”¹ Step 01: Update Directory Structure

```bash
â”œâ”€â”€ install_httpd.yml
â”œâ”€â”€group_vars
â”‚   â””â”€â”€ all.yml
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html.j2   # Jinja2 template
â””â”€â”€ files/
    â””â”€â”€ (optional static files)
```

## ðŸ”¹ Step 02: Create a Jinja2 Template

Modify `templates/index.html.j2` to include dynamic content:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>{{ page_title }}</title>
  </head>
  <body>
    <h1>{{ welcome_message }}</h1>
    <p>Hostname: {{ ansible_hostname }}</p>
    <p>OS: {{ ansible_os_family }} {{ ansible_distribution_version }}</p>
    <p>Timestamp: {{ ansible_date_time.iso8601 }}</p>

    {% if additional_message is defined %}
    <div>{{ additional_message }}</div>
    {% endif %}
  </body>
</html>
```

## ðŸ”¹ Step 03: Update the Playbook

Modify `httpd.yaml` to use the template and define variables:

```yaml
---
- name: Install and configure Apache HTTP Server on RHEL 9
  hosts: all
  become: yes
  vars:
    page_title: "Apache Server"
    welcome_message: "Welcome to {{ inventory_hostname }}"
    additional_message: "This server is managed by Jinja2!" # Optional variable

  tasks:
    - name: Install httpd package
      yum:
        name: httpd
        state: present

    - name: Ensure httpd service is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Deploy dynamic index.html using Jinja2
      ansible.builtin.template: # Replace 'copy' with 'template'
        src: templates/index.html.j2
        dest: /var/www/html/index.html
        owner: apache
        group: apache
        mode: 0644
      notify:
        - Reload httpd

    - name: Open firewall ports for HTTP/HTTPS (optional)
      ansible.builtin.firewalld:
        service: "{{ item }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ firewall_services }}" # Use a variable for flexibility
      when:
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version == '9'
      notify:
        - Reload firewalld

  handlers:
    - name: Reload firewalld
      ansible.builtin.service:
        name: firewalld
        state: reloaded

    - name: Reload httpd
      ansible.builtin.service:
        name: httpd
        state: reloaded
```

## ðŸ”¹ Step 04 : Add Variables (Optional)

Define variables in `group_vars/all.yml` or directly in the playbook:

```yaml
# Example group_vars/all.yml
firewall_services:
  - http
  - https
additional_message: "This server is part of the {{ env }} environment" # Use with `-e env=prod`
```

## ðŸ”¹ Step 05 : Add Tags to the Playbook

Update `httpd.yaml` to include tags for selective execution:

```yaml
---
- name: Install and configure Apache HTTP Server on RHEL 9
  hosts: all
  become: yes
  vars:
    page_title: "Apache Server"
    welcome_message: "Welcome to {{ inventory_hostname }}"
    additional_message: "This server is managed by Jinja2!" # Optional variable

  tasks:
    - name: Install httpd package
      yum:
        name: httpd
        state: present
      tags: # Add tags here
        - install
        - packages

    - name: Ensure httpd service is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes
      tags: # Add tags here
        - service
        - configure

    - name: Deploy dynamic index.html using Jinja2
      ansible.builtin.template:
        src: templates/index.html.j2
        dest: /var/www/html/index.html
        owner: apache
        group: apache
        mode: 0644
      notify:
        - Reload httpd
      tags: # Add tags here
        - deploy
        - configure

    - name: Open firewall ports for HTTP/HTTPS (optional)
      ansible.builtin.firewalld:
        service: "{{ item }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ firewall_services }}"
      when:
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version == '9'
      notify:
        - Reload firewalld
      tags: # Add tags here
        - firewall
        - security

  handlers:
    - name: Reload firewalld
      ansible.builtin.service:
        name: firewalld
        state: reloaded

    - name: Reload httpd
      ansible.builtin.service:
        name: httpd
        state: reloaded
```

## Step 6: Use Tags to Control Execution

Run the playbook with specific tags using `--tags` or `--skip-tags`:

- **Example 1**: Run only the installation tasks

```bash
ansible-playbook -i inventory httpd.yaml --tags "install,packages"
```

**Example 2**: Deploy the website without touching services or firewall

```bash
ansible-playbook -i inventory httpd.yaml --tags "deploy"
```

**Example 3**: Skip firewall configuration

```bash
ansible-playbook -i inventory httpd.yaml --skip-tags "firewall"
```

**Example 4**: Run all tasks tagged as "configure"

```bash
ansible-playbook -i inventory httpd.yaml --tags "configure"
```

## Concepts: Tags

**Tags** are labels assigned to tasks, plays, or roles to control which parts of a playbook execute.

### **Key Features**:

- **Selective Execution**: Run only tasks with specific tags (e.g., `--tags "deploy"`).
- **Skipping Tasks**: Exclude tasks with specific tags (e.g., `--skip-tags "firewall"`).
- **Multiple Tags**: A task can have multiple tags (e.g., `tags: [install, packages]`).
- **Inheritance**: Tags from roles or imports apply to all child tasks.

### Common Use Cases:

- Separate installation, configuration, and deployment phases.
- Skip non-critical tasks in dry runs.
- Reuse playbooks for different environments (e.g., prod vs dev).
